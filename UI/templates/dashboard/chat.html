<div class="card">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="card-title mb-0">üí¨ –ß–∞—Ç —Å –ø–æ–º–æ—â–Ω–∏–∫–æ–º</h2>
            <button class="btn btn-outline-danger btn-sm" onclick="clearChat()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
        </div>
        
        <div id="chatContainer" class="border rounded p-3 mb-3" style="height: 400px; overflow-y: auto; background: #f8f9fa;">
            <div id="chatMessages">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>
        
        <form id="chatForm" onsubmit="sendMessage(event)">
            <div class="input-group">
                <input type="text" class="form-control" id="messageInput" 
                       placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required>
                <button class="btn btn-primary" type="submit">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<script>
let chatMessages = [];

function loadChatHistory() {
    fetch('/api/chat/history')
        .then(response => response.json())
        .then(data => {
            if (data.messages) {
                chatMessages = data.messages;
                renderMessages();
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
            chatMessages = [{
                role: 'assistant',
                content: '–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à –ø–æ–º–æ—â–Ω–∏–∫. –ö–∞–∫ –¥–µ–ª–∞? –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?',
                timestamp: new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})
            }];
            renderMessages();
        });
}

function renderMessages() {
    const container = document.getElementById('chatMessages');
    container.innerHTML = '';
    
    chatMessages.forEach(msg => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `mb-3 ${msg.role === 'user' ? 'text-end' : ''}`;
        
        const card = document.createElement('div');
        card.className = `card ${msg.role === 'user' ? 'bg-primary text-white' : 'bg-light'}`;
        card.style.display = 'inline-block';
        card.style.maxWidth = '70%';
        
        const cardBody = document.createElement('div');
        cardBody.className = 'card-body p-2';
        
        const content = document.createElement('div');
        content.textContent = msg.content;
        content.style.whiteSpace = 'pre-wrap';
        
        const timestamp = document.createElement('small');
        timestamp.className = 'text-muted';
        timestamp.textContent = msg.timestamp || '';
        
        cardBody.appendChild(content);
        cardBody.appendChild(document.createElement('br'));
        cardBody.appendChild(timestamp);
        card.appendChild(cardBody);
        messageDiv.appendChild(card);
        container.appendChild(messageDiv);
    });
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
    const chatContainer = document.getElementById('chatContainer');
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function sendMessage(event) {
    event.preventDefault();
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å—Ä–∞–∑—É
    chatMessages.push({
        role: 'user',
        content: message,
        timestamp: new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})
    });
    renderMessages();
    input.value = '';
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    fetch('/api/chat/send', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({message: message})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            chatMessages.push({
                role: 'assistant',
                content: data.response,
                timestamp: new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})
            });
            renderMessages();
        } else {
            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
    });
}

function clearChat() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞?')) {
        fetch('/api/chat/clear', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadChatHistory();
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏:', error);
        });
    }
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', loadChatHistory);
</script>

